<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://xamarin.com/schemas/2014/forms"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Siren.Views.MainPage"
             xmlns:vm="clr-namespace:Siren.ViewModels" 
             xmlns:views="clr-namespace:Siren.Views"
             xmlns:icons="clr-namespace:Siren.Assets"
             Title="{Binding Title}"
             BackgroundColor="{StaticResource VeryDark}"
             ControlTemplate="{StaticResource BusyPageTemplate}">

    <ContentPage.BindingContext>
        <vm:MainViewModel />
    </ContentPage.BindingContext>

    <ContentPage.Resources>
        <Style x:Key="AddButton" TargetType="Button">
            <Setter Property="FontFamily" Value="FA"/>
            <Setter Property="Text" Value="{x:Static icons:FAFont.SquarePlus}"/>
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="HorizontalOptions" Value="Start"/>
            <Setter Property="CornerRadius" Value="5"/>
            <Setter Property="HeightRequest" Value="35"/>
            <Setter Property="WidthRequest" Value="35"/>
            <Setter Property="TextColor" Value="{StaticResource VeryDark}"/>
        </Style>
        <Style x:Key="FreeSpaceProgressBar" TargetType="ProgressBar">
            <Setter Property="VerticalOptions" Value="Center"/>
            <Setter Property="BackgroundColor" Value="{StaticResource Dark}"/>
            <Setter Property="ProgressColor" Value="{StaticResource Green}"/>
        </Style>
        <Style x:Key="AddSettingButton" TargetType="Button">
            <Setter Property="FontFamily" Value="FA"/>
            <Setter Property="Text" Value="{x:Static icons:FAFont.SquarePlus}"/>
            <Setter Property="FontSize" Value="36"/>
            <Setter Property="TextColor" Value="{StaticResource VeryDark}"/>
            <Setter Property="CornerRadius" Value="15"/>
            <Setter Property="BackgroundColor" Value="{StaticResource Light}"/>
        </Style>
    </ContentPage.Resources>

    <Grid RowDefinitions="auto,*,1.03*,auto" ColumnDefinitions="310,1.7*,*" ColumnSpacing="10" RowSpacing="0" >

        <!--Settings-->
        <Grid Grid.Row="0" Grid.RowSpan="3" Grid.Column="0" RowDefinitions="auto,*">
            <Grid Grid.Row="0" Padding="10,10,0,10" RowDefinitions="85" ColumnDefinitions="300">
                <Button Style="{StaticResource AddSettingButton}" Command="{Binding AddSettingCommand}"/>
            </Grid>
            <ScrollView Grid.Row="1" Orientation="Vertical" VerticalScrollBarVisibility="Never">
                <StackLayout x:Name="SettingsList" Grid.Row="0" BindableLayout.ItemsSource="{Binding Settings}" Spacing="10" HorizontalOptions="Center" Padding="0">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate>
                            <views:SettingCardView>
                                <views:SettingCardView.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding BindingContext.SelectSettingCommand,Source={x:Reference SettingsList}}" 
                                                          CommandParameter="{Binding .}"/>
                                </views:SettingCardView.GestureRecognizers>
                            </views:SettingCardView>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </StackLayout>
            </ScrollView>
        </Grid>

        <!--Scenes-->
        <Grid Grid.Row="0" Grid.Column="1" Grid.ColumnSpan="2" HeightRequest="100" ColumnDefinitions="auto,*">
            <Grid Grid.Column="0" Padding="0,10,10,10" RowDefinitions="85" ColumnDefinitions="85">
                <Button Style="{StaticResource AddSettingButton}" Command="{Binding AddSceneCommand}" IsVisible="{Binding ShowSettingEditTools}"/>
            </Grid>
            <ScrollView Orientation="Horizontal" Grid.Column="1">
                <StackLayout x:Name="ScenesList" Grid.Row="0" BindableLayout.ItemsSource="{Binding SelectedSetting.Scenes}" 
                             Orientation="Horizontal" Spacing="10" Padding="0,0,10,0">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate>
                            <views:SceneCardView>
                                <views:SceneCardView.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding BindingContext.SelectSceneCommand,Source={x:Reference ScenesList}}" 
                                                          CommandParameter="{Binding .}"/>
                                </views:SceneCardView.GestureRecognizers>
                            </views:SceneCardView>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </StackLayout>
            </ScrollView>
        </Grid>

        <!--Elements-->
        <Grid Grid.Row="1" Grid.Column="1" RowDefinitions="auto,*">
            <Grid Grid.Row="0" Padding="0,10" ColumnSpacing="10" ColumnDefinitions="auto,*">
                <Button Grid.Column="0" Style="{StaticResource AddButton}" Command="{Binding AddElementsCommand}" IsVisible="{Binding ShowSettingEditTools}"/>
                <Grid Grid.Column="1" RowDefinitions="*,auto" VerticalOptions="Center" HorizontalOptions="Fill" RowSpacing="5" BackgroundColor="Yellow">
                    <Label Grid.Row="0" Text="{Binding CurrentElementsCountString}" VerticalOptions="Center" VerticalTextAlignment="Center"/>
                    <ProgressBar Grid.Row="1" Style="{StaticResource FreeSpaceProgressBar}" Progress="{Binding FreeElementsSpace}" HorizontalOptions="Fill"/>
                </Grid>
            </Grid>
            <Frame Grid.Row="1" Padding="0" BackgroundColor="{StaticResource Dark}" CornerRadius="{StaticResource CornerRadiusOuter}">
                <ScrollView  VerticalScrollBarVisibility="Never">
                    <FlexLayout x:Name="ElementsList" 
                                BindableLayout.ItemsSource="{Binding SelectedSetting.Elements}" 
                                Wrap="Wrap" 
                                Direction="Row" 
                                JustifyContent="Start"
                                AlignContent="Start"
                                AlignItems="Start"
                                Padding="5">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate>
                                <views:ElementPlayerView/>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </FlexLayout>
                </ScrollView>
            </Frame>
        </Grid>

        <!--Music-->
        <Grid Grid.Row="1" Grid.Column="2" Grid.RowSpan="2" RowDefinitions="auto,*" Margin="0,0,10,0">
            <StackLayout Grid.Row="0" Orientation="Horizontal" Padding="0,10" Spacing="10">
                <Button Style="{StaticResource AddButton}" Command="{Binding AddEffectsCommand}" IsVisible="{Binding ShowSettingEditTools}"/>
                <StackLayout Orientation="Vertical" VerticalOptions="Center">
                    <Label Text="{Binding CurrentEffectsCountString}" VerticalOptions="Center" VerticalTextAlignment="Center"/>
                    <ProgressBar Style="{StaticResource FreeSpaceProgressBar}" Progress="{Binding FreeEffectsSpace}"/>
                </StackLayout>
            </StackLayout>
            <Frame Grid.Row="1" Padding="0" BackgroundColor="{StaticResource Dark}" CornerRadius="{StaticResource CornerRadiusOuter}">
                <ScrollView Grid.Row="1" Padding="0" Margin="0"  VerticalScrollBarVisibility="Never">
                    <StackLayout x:Name="MusicList" BindableLayout.ItemsSource="{Binding SelectedSetting.Effects}" 
                                 Padding="10" Spacing="10">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate>
                                <views:MusicPlayerView/>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </StackLayout>
                </ScrollView>
            </Frame>
        </Grid>
        
        <!--Effects-->
        <Grid Grid.Row="2" Grid.Column="1" RowDefinitions="auto,*">
            <StackLayout Grid.Row="0" Orientation="Horizontal" Padding="0,15,10,10" Spacing="10">
                <Button Style="{StaticResource AddButton}" Command="{Binding AddEffectsCommand}" IsVisible="{Binding ShowSettingEditTools}"/>
                <StackLayout Orientation="Vertical" VerticalOptions="Center">
                    <Label Text="{Binding CurrentEffectsCountString}" VerticalOptions="Center" VerticalTextAlignment="Center"/>
                    <ProgressBar Style="{StaticResource FreeSpaceProgressBar}" Progress="{Binding FreeEffectsSpace}"/>
                </StackLayout>
            </StackLayout>
            <Frame Grid.Row="1" Padding="0" BackgroundColor="{StaticResource Dark}" CornerRadius="{StaticResource CornerRadiusOuter}">
                <ScrollView Grid.Row="1" Padding="0" Margin="0" VerticalScrollBarVisibility="Never">
                    <FlexLayout x:Name="EffectsList" 
                            BindableLayout.ItemsSource="{Binding SelectedSetting.Effects}" 
                            Wrap="Wrap" 
                            Direction="Row" 
                            JustifyContent="Start"
                            AlignContent="Start"
                            AlignItems="Start"
                            Padding="5">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate>
                                <views:EffectPlayerView/>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </FlexLayout>
                </ScrollView>
            </Frame>
        </Grid>

        <Grid Grid.Row="3" Grid.ColumnSpan="2">
            <StackLayout Orientation="Horizontal" Margin="10" Spacing="10">
                <Grid WidthRequest="300" HeightRequest="50">
                    <Button FontFamily="FA" Text="{x:Static icons:FAFont.CirclePlay}" FontSize="32"
                            Command="{Binding GlobalPlayCommand}"
                            BackgroundColor="{StaticResource DarkGreen}"
                            HorizontalOptions="Fill"
                            CornerRadius="15">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" Binding="{Binding IsScenePlaying}" Value="True">
                                <Setter Property="Text" Value="{x:Static icons:FAFont.CircleStop}"/>
                                <Setter Property="BackgroundColor" Value="{StaticResource Red}"/>
                            </DataTrigger>
                            <DataTrigger TargetType="Button" Binding="{Binding GlobalPlayActivityIndicatorIsVisible}" Value="True">
                                <Setter Property="Text" Value=""/>
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>
                    <ActivityIndicator IsVisible="{Binding GlobalPlayActivityIndicatorIsVisible}" IsRunning="True" Color="White"/>
                </Grid>
                
                <Label Text="{Binding CurrentSceneText}" 
                       HorizontalOptions="Start" 
                       FontSize="24" 
                       VerticalOptions="Center" VerticalTextAlignment="Center"
                       Margin="10,0,0,0"
                       FontFamily="Lora"/>
                
            </StackLayout>
        </Grid>
    </Grid>

</ContentPage>
